# Nome do Workflow
name: ğŸš€ Deploy Suzi Artesanatos para Fly.io

# Define quando este workflow serÃ¡ executado
on:
  # Executa toda vez que houver um push para a branch 'main'
  push:
    branches: ["main"]
  # Permite executar manualmente a partir da interface do GitHub Actions
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Puxa o cÃ³digo do repositÃ³rio (NecessÃ¡rio para Fly.io ler o fly.toml e o Dockerfile)
      - name: ğŸ“¦ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      # 2. Configura o Node.js
      - name: âš™ï¸ Configurar Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      # 3. Cache de dependÃªncias (Opcional, mas acelera o processo)
      - name: âš¡ Restaurar Cache de npm
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. Instalar dependÃªncias (apenas se nÃ£o houver cache)
      - name: Instalar DependÃªncias
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

      # 5. Build e Deploy (A Action oficial faz a autenticaÃ§Ã£o com o FLY_API_TOKEN)
      - name: ğŸš€ Fazer Deploy no Fly.io
        uses: superfly/flyctl-actions/deploy@master
        with:
          # A Action usarÃ¡ o fly.toml e o Dockerfile
          args: deploy
        env:
          # ğŸš¨ SECRETS DO GITHUB:
          # O token de API Fly.io (para autenticaÃ§Ã£o)
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} 
          
          # VariÃ¡veis de Ambiente da sua aplicaÃ§Ã£o (Admin e Senha)
          ADMIN_USER: ${{ secrets.ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
