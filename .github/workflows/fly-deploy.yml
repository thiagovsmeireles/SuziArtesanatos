# Nome do Workflow
name: ğŸš€ Deploy Suzi Artesanatos to Fly.io

# Define quando este workflow serÃ¡ executado
on:
  # Executa toda vez que houver um push para a branch 'main'
  push:
    branches: ["main"]
  # Permite executar manualmente a partir da interface do GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Puxa o cÃ³digo do repositÃ³rio (Usando a versÃ£o mais atual @v4)
      - name: ğŸ“¦ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      # 2. Configura o Node.js
      - name: âš™ï¸ Configurar Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. Opcional, mas acelera: cache de dependÃªncias
      - name: âš¡ Restaurar Cache de npm
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. Instalar dependÃªncias (se o cache falhar)
      - name: Instalar DependÃªncias
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

      # 5. Build, Push e Deploy para o Fly.io usando a action oficial
      # ESTA ÃšNICA ETAPA substitui seus passos 2, 3 e 4.
      - name: ğŸš€ Fazer Deploy no Fly.io
        uses: superfly/flyctl-actions/deploy@master
        with:
          # O argumento 'deploy' usa seu fly.toml e Dockerfile
          args: deploy
        env:
          # ğŸš¨ SECRETS CRUCIAIS:
          # A action usa este token para se autenticar e fazer o deploy
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} 
          
          # Estes sÃ£o injetados na sua aplicaÃ§Ã£o Next.js
          ADMIN_USER: ${{ secrets.ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
          # NODE_ENV jÃ¡ estÃ¡ em fly.toml, mas se precisar, pode pÃ´r aqui tambÃ©m:
          NODE_ENV: production
