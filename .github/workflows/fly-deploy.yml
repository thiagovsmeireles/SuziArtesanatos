# Nome do Workflow
name: üöÄ Deploy Suzi Artesanatos to Fly.io

# Define quando este workflow ser√° executado
on:
  # Executa toda vez que houver um push para a branch 'main'
  push:
    branches: ["main"]
  # Permite executar manualmente a partir da interface do GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Puxa o c√≥digo do reposit√≥rio (Usando a vers√£o mais atual @v4)
      - name: üì¶ Checkout do Reposit√≥rio
        uses: actions/checkout@v4

      # 2. Configura o Node.js
      - name: ‚öôÔ∏è Configurar Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. Opcional, mas acelera: cache de depend√™ncias
      - name: ‚ö° Restaurar Cache de npm
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. Instalar depend√™ncias (se o cache falhar)
      - name: Instalar Depend√™ncias
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci

      # 5. Build, Push e Deploy para o Fly.io usando a action oficial
      - name: üöÄ Fazer Deploy no Fly.io
        # CORRIGIDO: Removido o '/deploy' para usar a Action principal
        uses: superfly/flyctl-actions@master
        with:
          # CORRIGIDO: For√ßando o uso do Dockerfile para evitar o erro de 'launch manifest'
          args: deploy --dockerfile ./Dockerfile
        env:
          # üö® SECRETS CRUCIAIS:
          # A action usa este token para se autenticar e fazer o deploy
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} 
          
          # Estes s√£o injetados na sua aplica√ß√£o Next.js
          ADMIN_USER: ${{ secrets.ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
          # NODE_ENV j√° est√° em fly.toml, mas se precisar, pode p√¥r aqui tamb√©m:
          NODE_ENV: production
